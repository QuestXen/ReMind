name: 'Release with Auto-Updater'

on:
  push:
    tags:
      - v*.*.*
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23'
          
      - name: Install frontend dependencies
        run: npm ci

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Build Tauri with Updater
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'ReMind v__VERSION__'
          releaseBody: |
            ## ReMind v__VERSION__
            
            ### Was ist neu?
            - Automatische Updates sind jetzt verfügbar
            - Verbesserte Performance und Stabilität
            
            ### Installation
            Laden Sie die .msi Datei herunter und führen Sie sie aus.
            
            ### Auto-Update
            Die App prüft automatisch auf Updates beim Start.
            
            Siehe [CHANGES.md](https://github.com/QuestXen/ReMind/blob/main/CHANGES.md) für eine vollständige Liste der Änderungen.
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
          includeUpdaterJson: true

  create-updater-json:
    needs: publish-tauri
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # Nur bei Tag-Push ausführen
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Get release info
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            console.log('Looking for release with tag:', tag);
            
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });
            
            // Find Windows installer asset
            const windowsAsset = release.data.assets.find(asset => 
              asset.name.endsWith('.msi') || asset.name.endsWith('.exe')
            );
            
            // Find signature file
            const sigAsset = release.data.assets.find(asset => 
              asset.name.endsWith('.msi.sig') || asset.name.endsWith('.exe.sig')
            );
            
            if (!windowsAsset || !sigAsset) {
              throw new Error('Windows installer or signature file not found');
            }
            
            return {
              version: tag,
              notes: release.data.body || 'Update verfügbar',
              pub_date: release.data.published_at,
              url: windowsAsset.browser_download_url,
              signature: sigAsset.browser_download_url
            };

      - name: Download signature file
        run: |
          curl -L -o signature.sig "${{ fromJson(steps.get_release.outputs.result).signature }}"
          
      - name: Create latest.json
        run: |
          cat > latest.json << EOF
          {
            "version": "${{ fromJson(steps.get_release.outputs.result).version }}",
            "notes": "${{ fromJson(steps.get_release.outputs.result).notes }}",
            "pub_date": "${{ fromJson(steps.get_release.outputs.result).pub_date }}",
            "platforms": {
              "windows-x86_64": {
                "signature": "$(cat signature.sig)",
                "url": "${{ fromJson(steps.get_release.outputs.result).url }}"
              }
            }
          }
          EOF

      - name: Upload latest.json to release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const tag = context.ref.replace('refs/tags/', '');
            
            // Get release
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });
            
            // Upload latest.json
            const latestJson = fs.readFileSync('latest.json');
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              name: 'latest.json',
              data: latestJson,
              headers: {
                'content-type': 'application/json'
              }
            });
            
            console.log('latest.json uploaded successfully');

      - name: Verify updater endpoint
        run: |
          echo "Auto-updater endpoint:"
          echo "https://github.com/QuestXen/ReMind/releases/latest/download/latest.json"
          echo ""
          echo "latest.json content:"
          cat latest.json